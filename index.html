<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <title>Check-in voor de Wissel-les of MB</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 520px; margin: auto; line-height: 1.4; }
    h2 { margin: 0 0 10px; }
    p { margin: 8px 0; }
    input, label, button, select { display: block; width: 100%; margin-top: 10px; font-size: 1em; }
    input, select { padding: 10px; border: 1px solid #ddd; border-radius: 8px; }
    button { padding: 10px; border: 0; border-radius: 8px; background: #111; color: #fff; font-weight: 700; cursor: pointer; }
    button.secondary { background: #f1f1f1; color: #111; border: 1px solid #ddd; }
    #formulier { display: none; margin-top: 12px; }
    #status { font-weight: bold; margin-top: 12px; }
    #retryButton { display: none; margin-top: 8px; }
    #melding { display: none; padding: 10px; margin: 14px 0; border-radius: 8px; }
    .success { background-color: #d4edda; color: #155724; }
    .error { background-color: #f8d7da; color: #721c24; }
    .info { background-color: #cce5ff; color: #004085; }
    .hint { color:#6c757d; font-size:.95em; margin-top:8px; }
  </style>
</head>
<body>
  <h2>Check-in Wissel-les of MB</h2>
  <p>Ben je op school? Klik hieronder. We kijken of je dicht genoeg bij school bent. üëá</p>

  <div id="melding"></div>

  <button type="button" onclick="checkLocation()">üìç Check mijn locatie</button>
  <button id="retryButton" class="secondary" type="button" onclick="retryLocation()">Probeer locatie delen opnieuw</button>
  <div id="status"></div>
  <div id="httpsHint" class="hint"></div>

  <div id="formulier">
    <form id="checkinForm" onsubmit="verzenden(event)">
      <label for="voornaam">Wat is je voornaam?</label>
      <input type="text" id="voornaam" name="voornaam" required>

      <label for="achternaam">En je achternaam?</label>
      <input type="text" id="achternaam" name="achternaam" required>

      <label for="studentnummer">Wat is je studentnummer?</label>
      <input type="text" id="studentnummer" name="studentnummer" required>

      <label for="email">En je e-mailadres?</label>
      <input type="email" id="email" name="email" required>

      <input type="hidden" id="lat" name="lat">
      <input type="hidden" id="lng" name="lng">

      <button id="submitBtn" type="submit">‚úÖ Inchecken</button>
    </form>
  </div>

  <script>
    // ===== Instellingen (zoals voorheen) =====
    const locaties = [
      { lat: 52.0682, lng: 4.3248 },
      { lat: 52.0360341, lng: 4.3623357 },
      { lat: 52.0668769, lng: 4.3235892 }
    ];
    const maxAfstand = 350; // meters
    const ENDPOINT = "https://script.google.com/macros/s/AKfycbxUYQbzgvxZnZm8QDbqdevXoWFtblh5OQSqtDFgNuwTNKqiqf3rakcY3qHFslTUilEj/exec";

    // ===== Kleine helpers =====
    function $(id){ return document.getElementById(id); }

    function toonMelding(tekst, type) {
      const melding = $("melding");
      melding.className = "";
      if (type) melding.classList.add(type);
      melding.textContent = tekst;
      melding.style.display = "block";
      // melding verdwijnt na 5s
      setTimeout(() => { melding.style.display = "none"; }, 5000);
    }

    function afstandInMeters(lat1, lon1, lat2, lon2) {
      const R = 6371e3;
      const œÜ1 = lat1 * Math.PI / 180;
      const œÜ2 = lat2 * Math.PI / 180;
      const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
      const ŒîŒª = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(ŒîœÜ / 2) ** 2 + Math.cos(œÜ1) * Math.cos(œÜ2) * Math.sin(ŒîŒª / 2) ** 2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function httpsCheck(){
      // Geolocatie werkt alleen op https of localhost
      if (location.protocol !== "https:" && location.hostname !== "localhost") {
        $("httpsHint").textContent = "Tip: gebruik https (of localhost). Op http blokkeert de browser vaak je locatie.";
      }
    }

    // ===== Locatie flow =====
    function checkLocation() {
      $("retryButton").style.display = "none";
      $("status").textContent = "";

      if (!navigator.geolocation) {
        $("status").textContent = "‚ùå Je apparaat ondersteunt geen GPS.";
        return;
      }

      $("status").textContent = "üìç Locatie ophalen‚Ä¶ geef toestemming alstublieft.";
      navigator.geolocation.getCurrentPosition(
        locatieSucces,
        locatieMislukt,
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 30000 }
      );
    }

    function retryLocation() {
      $("status").textContent = "üìç We proberen het opnieuw‚Ä¶";
      navigator.geolocation.getCurrentPosition(
        locatieSucces,
        locatieMisluktFinal,
        { enableHighAccuracy: true, timeout: 12000, maximumAge: 0 }
      );
    }

    function locatieSucces(position) {
      const lat = position.coords.latitude;
      const lon = position.coords.longitude;
      $("lat").value = lat;
      $("lng").value = lon;

      let goedgekeurd = false;
      let kortsteAfstand = Infinity;

      for (var i=0; i<locaties.length; i++){
        const d = afstandInMeters(lat, lon, locaties[i].lat, locaties[i].lng);
        if (d < maxAfstand) { goedgekeurd = true; break; }
        if (d < kortsteAfstand) kortsteAfstand = d;
      }

      if (goedgekeurd) {
        $("status").textContent = "‚úÖ Top! Je bent op de juiste plek. Vul nu je gegevens in.";
        $("formulier").style.display = "block";
      } else {
        const afgerond = Math.round(kortsteAfstand);
        $("status").textContent = "‚ùå Niet op een goedgekeurde plek. Dichtstbijzijnde locatie: ongeveer " + afgerond + " meter.";
        $("formulier").style.display = "none";
        $("retryButton").style.display = "inline-block";
      }
    }

    function locatieMislukt(error) {
      $("status").textContent = "üìç We konden je locatie niet vinden of je hebt het geweigerd. Probeer het opnieuw.";
      $("retryButton").style.display = "inline-block";
    }

    function locatieMisluktFinal(error) {
      $("status").textContent = "‚ùå Locatie ophalen lukt niet. Sta locatie delen toe in je browser of probeer een andere browser.";
      $("retryButton").style.display = "none";
    }

    // ===== Verzenden flow (zoals voorheen) =====
    function verzenden(event) {
      event.preventDefault();

      const vandaag = new Date().toISOString().split("T")[0];
      const laatstIngecheckt = localStorage.getItem("checkin_datum_mb");

      if (laatstIngecheckt === vandaag) {
        toonMelding("‚è≥ Je hebt vandaag al ingecheckt op dit apparaat.", "info");
        return;
      }

      const form = event.target;
      const formData = new FormData(form);
      formData.append('tijd', new Date().toLocaleString());

      // kleine validatie e-mail
      var email = $("email").value.trim();
      var emailOK = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
      if (!emailOK){
        toonMelding("‚ùå Vul een geldig e-mailadres in.", "error");
        $("email").focus();
        return;
      }

      // knop tijdelijk uit
      var submitBtn = $("submitBtn");
      if (submitBtn) {
        submitBtn.disabled = true;
        var oudeTekst = submitBtn.textContent;
        submitBtn.textContent = "Bezig‚Ä¶";
      }

      fetch(ENDPOINT, { method: "POST", body: formData })
        .then(function(response){
          return response.text().then(function(text){ return { ok: response.ok, status: response.status, text: text }; });
        })
        .then(function(res){
          if (!res.ok) {
            throw new Error("Serverfout (" + res.status + ")");
          }
          if (res.text === "OK") {
            toonMelding("‚úÖ Je bent ingecheckt. Dankjewel!", "success");
            localStorage.setItem("checkin_datum_mb", vandaag);
            form.reset();
            $("formulier").style.display = "none";
            $("status").textContent = "";
          } else if (res.text === "AL_GEDAAN_VANDAAG") {
            toonMelding("‚è≥ Je hebt vandaag al ingecheckt (volgens het systeem).", "info");
          } else {
            toonMelding("‚ùå Oei! Het opslaan ging mis. Antwoord: " + res.text, "error");
          }
        })
        .catch(function(error){
          toonMelding("‚ùå Foutje bij het versturen: " + error.message, "error");
        })
        .finally(function(){
          if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.textContent = oudeTekst;
          }
        });
    }

    // start
    httpsCheck();
  </script>
</body>
</html>
